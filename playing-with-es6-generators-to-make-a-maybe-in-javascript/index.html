<!doctype html>
      <head>
        <title>Playing with ES6 generators to make a Maybe in Javascript</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="
" >
        <link rel="stylesheet" href="/css/normalize.css" type="text/css">
        <link rel="stylesheet" href="/css/style.css" type="text/css">
        <link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
        <link rel="alternate" type="application/rss+xml" title="Subscribe to RSS feed" href="/rss.xml" />
      </head>
      <body class="article">
        <div class="mast">
          <div class='top-bar reading'>
              <div class="links logical">
                <div class="navigation logical">
                  <a href="/">Home</a>
                  <a href="/rss.xml">RSS</a>
                  <a href="/me">
                      Tim Ruffles
                  </a>
                </div>
              </div>
            </div>
        </div>
        <div class="content" class="reading">
           

           <div class="body">
              <h1><a href="/playing-with-es6-generators-to-make-a-maybe-in-javascript">Playing with ES6 generators to make a Maybe in Javascript</a></h1>
  <div class="summary">
  If you know about Either, Maybe and JS generators already just take a look <a href="https://gist.github.com/timruffles/6129848">at the code</a>.
</div>

<p>Javascript <a href="http://tc39wiki.calculist.org/es6/" >ES6</a> is likely to <a href="http://wiki.ecmascript.org/doku.php?id=harmony:generators" >introduce generators</a> into the language. A number of cool things are enabled by generators&#39; ability to control the flow of a function from outside.</p>
<p>I&#39;ve used them here to build a useful boiler-plate reduction tool similar to the idea of Haskell&#39;s <a href="http://learnyouahaskell.com/for-a-few-monads-more#error" >Either</a> and <a href="http://learnyouahaskell.com/a-fistful-of-monads#getting-our-feet-wet-with-maybe" >Maybe</a>. It&#39;s not intended as something to use, just as an experiment.</p>
<h2 id="whats-either-a-maybe-or-a">What&#39;s Either a Maybe or a...</h2>
<p>If you don&#39;t know about Maybe and Either, I&#39;ll give a brief intro. If you do - <a href="#in-js" >let&#39;s talk about JS</a>. There are <a href="http://learnyouahaskell.com/a-fistful-of-monads#getting-our-feet-wet-with-maybe" >better</a> <a href="http://learnyouahaskell.com/for-a-few-monads-more#error" >guides</a>, but I&#39;ll have a go:</p>
<p>Either and Maybe replace code that checks for invalid values in a process. Maybe handles missing things: no matching record in the database, no such key in a Map. Either handles things that could go wrong - no such file, numerical calculations out of domain etc.</p>
<p>The core idea is to split what you want to do with something apart from checking and handling whether it&#39;s missing or invalid. Rather than having lots of error checking after each potentially missing/erroneous step, you simply write your code as if everything is perfect, and Either and Maybe&#39;s machinery will handle any problems. Here&#39;s an example:</p>
<pre>var user = database.find(params["id"])
var number = user.fetch("optional-number-field")
var log = Math.log(number) # could be NaN if -1 or undefined
</pre>

<p>Here we have 2 potential Nothing values (db search, fetch a field), and one potential invalid result (Math.log is undefined for negative numbers). If we add in the error checking we make it harder to read:</p>
<pre>var user = database.find(params["id"])
if(!user) return;
var number = user.fetch("optional-number-field")
// check for missing, or out of domain values
if(number == null || number &lt; 0) return; 
var log = Math.log(number)
</pre>

<p>With Either and Maybe we can just write the process we want to carry out if everything is there and correct, and let other code handle the errors. Obviously in lots of cases you want to know about error states, and this example is probably bad, but hopefully you can think of cases where you don&#39;t need to handle errors on a granular level.</p>
<h3 id="jquery-is-an-existing-javascript-example">jQuery is an existing Javascript example</h3>
<p>A well-known example is jQuery, in which calling DOM manipulations on a selection you made that found nothing doesn&#39;t cause a bug. Often you don&#39;t care about something not being there, you&#39;re just defining what happens if it is:</p>
<pre>function select(item) {
  $(".selected").removeClass(".selected")
  $("[data-id=" + item.id + "]").addClass(".selected")
}
</pre>

<p>Here we&#39;ve got a select handler that first deselects the previously selected item. It&#39;s less code to just specify that any selected items are deselect them that to specifically try to find them, do something if they&#39;re found, or nothing if not.</p>
<p><a id="in-js" href="/"></a></p>
<h2 id="javascript-generators-get-in-on-the-game">Javascript generators get in on the game</h2>
<p>Javascript generators let you do a similar thing. I&#39;ll not explain generators in depth here, but the core concept is yield returns control to the code that&#39;s calling the generator, and &quot;blocks&quot; there until the generator is resumed.</p>
<pre>var numericalProcess = function*() {
  yield Math.log
  yield function(x) { return x - 1 }
  yield Math.log
  yield Math.sqrt
  yield Math.log
}
</pre>

<p>This process has 3 potential invalid values from the Math.log, but we can just write it without any error checking. We&#39;re going to define a MaybeGenerator that implements this. The final result will be a tool that correctly allows us to avoid any NaN values, while the process runs fine without explicit checks:</p>
<pre>var safeNumericalExample = MaybeGenerator(isNaN,numericalProcess)

var shouldBeNothing = safeNumericalExample(-1)
var becomesNothingLater = safeNumericalExample(1)
var someNormalNumber = safeNumericalExample(1205)

console.log(shouldBeNothing)   // Nothing
console.log(becomesNothingLater)   // Nothing
console.log(someNormalNumber) // 0.29592896553598536...
</pre>

<p>The <code>MaybeGenerator</code> takes a list of functions that test for a value that stops the process, and the generator wrapping the process. Each step is passed the value from the previous one, threading the value through the steps in a point-free style (AKA not referring to arguments explicitly).</p>
<pre>var Nothing = {Nothing: true}

function MaybeGenerator() {
  var g = arguments[arguments.length - 1]
  // list of functions that test for any "Nothing" values
  var maybes = [].slice.call(arguments,0,arguments.length - 1)

  return function(value) {
    var generator = g.apply(null)
    var result
    var nothing = false
    while(result = generator.next(), !result.done) {
      value = result.value.call(null,value)
      if(maybes.some(function(mf) { return mf(value) })) {
        return Nothing
      }
    }
    return value
  }
}
</pre>

<p>Each time we call <code>generator.next()</code> the generator runs until it hits a <code>yield</code>. Once that happens we get a <code>{done: Boolean, value: Anything}</code> object back from the generator. We&#39;re yielding functions to apply to the value, so we apply it to the current value. If returns something one of our guard functions thinks is a Nothing, we return Nothing and we&#39;re done. Once the generator is finished (the function closes) we get a <code>{done: true, value: undefined}</code> and end the loop, returning the final value.</p>
<p>That rounds out the implementation! I&#39;m sure there are many more interesting &amp; sensible things to do with generators, they&#39;re extremely powerful.</p>

  <div class="article-footer">
  <p class=nav>
    Next: <a href="/twedar-machine-learning-side-project">
      Twedar - machine learning side project
    </a>
    </p>
  <p class=nav>
    Previous: <a href="/new-project-sidekickjs---javascript-code-quality-tool">
      New project: SidekickJS - Javascript code quality tool
    </a>
    </p>
        
    </div>
            </div>
        </div>
        <div class="footer reading">
          <div class="container">
            <p>ðŸ“© helloï¼ timr Â· co</p>
          </div>
        </div>
      </body><!-- built from 517edb9a5695013de15e0d0a4fbcd089be8c2bfe -->