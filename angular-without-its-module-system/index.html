<!doctype html>
      <head>
        <title>Angular without its module system</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="
" >
        <link rel="stylesheet" href="/css/normalize.css" type="text/css">
        <link rel="stylesheet" href="/css/style.css" type="text/css">
        <link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css">
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-24335480-1']);
          _gaq.push(['_trackPageview']);

          function asyncScript(src) {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = src;
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          }
          asyncScript(('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js');
        </script>
        <link rel="alternate" type="application/rss+xml" title="Subscribe to RSS feed" href="/rss.xml" />
      </head>
      <body class="article">
        <div id="mast">
          <div class='top-bar reading'>
              <div class="links logical">
                <div class="navigation logical">
                  <a href="/">Home</a>
                  <a href="/rss.xml">RSS</a>
                  <a href="/me">
                      Tim Ruffles
                  </a>
                </div>
              </div>
            </div>
        </div>
        <div id="content" class="reading">
           

           <div id="body">
              <h1><a href="/angular-without-its-module-system">Angular without its module system</a></h1>
  <p>I&#39;m going to demonstrate a way I&#39;ve used Angular that allows you to swap its module system for other, better ones.</p>
<h2 id="ripping-it-out">Ripping it out</h2>
<p>Angular&#39;s module system is integral to Angular. Your application is booted up by creating an injector with your boot module(s), and that&#39;s used to prime the compiler with the directives and controllers it needs, not to mention routing etc if you&#39;ve included it.</p>
<p>The module system creates a large blocker for lot of non-standard use cases - lazy-loading being an incredibly important one: if you&#39;re not inside that injector once it&#39;s created, you can&#39;t get at the same <em>instances</em> of the injector singletons the compiler uses: <code>$directiveProvider</code>, <code>$controllerProvider</code> and <code>$routeProvider</code>. A booted application can evidently only have one of these singletons, so it&#39;s hard to incrementally add controllers/directives/services.</p>
<p>So all non-standard uses of Angular&#39;s module system follow the same pattern:</p>
<ul>
<li>boot the app to create our injector singletons</li>
<li>grab them in <code>config()</code> and <code>run()</code> blocks</li>
<li>expose them to other code somehow: likely a module, or as globals (if you&#39;re in a hacky mood)</li>
<li>use them to incrementally add functionality</li>
</ul>
<h2 id="commonjs">CommonJS</h2>
<p>I&#39;ll demo the approach with CommonJS - the module system used by Node and browserify. Rather than defining angular modules, we&#39;ll create standard CommonJS modules that expose Angular functionality like controllers, directives and routes:</p>
<pre><code><span class="token comment">// user.js</span>
exports<span class="token punctuation">.</span>controllers <span class="token operator">=</span> <span class="token punctuation">{</span>
  UserCtrl<span class="token punctuation">:</span> UserCtrl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">"/users"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./views/user/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"/users/:id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    template<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./views/user/show.html"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">{</span>
  userProfile<span class="token punctuation">:</span> userProfile
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>To allow this we&#39;ll need a couple of tools: <code>browserify</code> and <code>stringify</code>. Browersify turns a set of CommonJS modules into a single file ready for use in the browser, with source-maps. <code>stringify</code> allow us to directly <code>require()</code> our templates, including them in the build distribution file. So to install we&#39;ll run:</p>
<pre><code>npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev browserify stringify</code></pre>
<h3 id="loading">Loading</h3>
<p>Now we&#39;ve defined our modules, what does application boot look like? Time for the &#39;ripping modules out of Angular&#39; algorithm:</p>
<pre><code><span class="token comment">// module that'll store our app singletons</span>
var ng <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../ng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// our code that exposes controllers, directives etc</span>
var deps <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./user"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./homepage"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// the sole time we call 'angular.module' in our app</span>
angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"ngRoute"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>$controllerProvider<span class="token punctuation">,</span> $compileProvider<span class="token punctuation">,</span> $routeProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span> 

  <span class="token comment">// expose all of the providers so we can register functionality later</span>
  _<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>ng<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    $controllerProvider<span class="token punctuation">:</span> $controllerProvider<span class="token punctuation">,</span>
    <span class="token comment">// ... the rest</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>controllers<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>controller<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $controllerProvider<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>directive<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $compileProvider<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> directive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>routes<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $routeProvider<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>   })
   .run(function($rootScope, $rootElement, $timeout, $location, $q) {
      _.extend(ng, {
        $rootScope: $rootScope,
        // ... the rest
      });
   });</p>
<h2 id="build-and-run">Build and run</h2>
<p>To build our app we run:</p>
<pre><code>browserify app<span class="token operator">/</span>boot<span class="token punctuation">.</span>js <span class="token operator">-</span>o dist<span class="token operator">/</span>app<span class="token punctuation">.</span>js</code></pre>
<p>If you&#39;d like to see this in action, here&#39;s a <a href="/" >live demo</a> and the <a href="/" >source code</a>.</p>
<h2 id="next-time">Next time</h2>
<p>In the next posts I&#39;ll address lazy-loading, dependency injection, and consider what we&#39;ve gained and lost by jettisoning Angular&#39;s module system.</p>

  
  
  
            </div>
        </div>
        <div class="footer reading">
          <div class="container">
            <p>📩 hello＠timr · co</p>
          </div>
        </div>
      </body>